---
- name: 01 - Node Pre-Configuration for Kubernetes
  hosts: awx_target
  become: yes
  gather_facts: yes
  vars:
    selinux_state: permissive
    ceph_osd_disk: /dev/sda # Target disk for Ceph OSDs

  tasks:
    - name: ⚠️ DANGER: Wipe partition table and metadata on {{ ceph_osd_disk }}
      # This task MUST be run. It ensures the disk is clean and ready for Rook-Ceph.
      # Ceph will fail if disks have remnants of previous filesystems or LVM.
      ansible.builtin.command: sgdisk --zap-all {{ ceph_osd_disk }}
      register: disk_wipe_result
      changed_when: disk_wipe_result.rc == 0
      
    - name: Clear all filesystem and partition signatures (Superblock)
      community.general.wipefs:
        device: "{{ ceph_osd_disk }}"
        force: yes
        all: yes
      register: wipefs_result
      changed_when: wipefs_result.changed or wipefs_result.stdout.find('cleared') != -1

    - name: Ensure OS is up-to-date
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_cache: yes

    - name: Disable swap permanently and immediately
      ansible.posix.mount:
        name: swap
        fstype: swap
        state: absent
    - name: Disable swap in memory
      ansible.builtin.command: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Load required kernel modules for K8s networking
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      with_items:
        - overlay
        - br_netfilter
    
    - name: Configure required sysctl parameters (bridged traffic and IP forwarding)
      ansible.posix.sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/99-kubernetes.conf
        reload: yes
      with_dict:
        net.bridge.bridge-nf-call-iptables: '1'
        net.ipv4.ip_forward: '1'
        net.bridge.bridge-nf-call-ip6tables: '1'

    - name: Set SELinux to permissive
      ansible.posix.selinux:
        state: "{{ selinux_state }}"
        policy: targeted

    - name: Enable and start CRI-O
      ansible.builtin.service:
        name: crio
        state: started
        enabled: yes

    - name: Stop and disable firewalld service (per user request)
      ansible.builtin.service:
        name: firewalld
        state: stopped
        enabled: no
      ignore_errors: yes
