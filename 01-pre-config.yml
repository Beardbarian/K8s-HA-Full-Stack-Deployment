---
- name: 01 - Node Pre-Configuration for Kubernetes
  hosts: awx_target
  become: yes
  gather_facts: yes
  vars:
    selinux_state: permissive
    ceph_osd_disk: /dev/sda # Target disk for Ceph OSDs on all nodes

  tasks:
    - name: Ensure all nodes can resolve each other by IP and hostname
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "{{ hostvars[item].ansible_host }} {{ item }}"
        state: present
      loop: "{{ groups['all'] }}"
      loop_control:
        label: "{{ item }}"

    - name: "Wipe partition table on {{ ceph_osd_disk }} (Unconditional Cleanup)"
      ansible.builtin.command: sgdisk --zap-all {{ ceph_osd_disk }}
      register: disk_wipe_result
      changed_when: disk_wipe_result.rc == 0
      ignore_errors: yes
      
    - name: Ensure OS packages are up-to-date
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_cache: yes

    # --- CRITICAL FIX: Install Python Kubernetes library for Ansible modules ---
    - name: Install Python Kubernetes library (Required for community.kubernetes modules)
      ansible.builtin.dnf:
        name: python3-kubernetes
        state: present
    # ---------------------------------------------------------------------------

    - name: Disable swap permanently (fstab)
      ansible.posix.mount:
        name: swap
        fstype: swap
        state: absent
        
    - name: Disable swap in memory (immediate)
      ansible.builtin.command: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Load required kernel modules for K8s networking (overlay, br_netfilter)
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      with_items:
        - overlay
        - br_netfilter
    
    - name: Configure required sysctl parameters (IP forwarding for CNI)
      ansible.posix.sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/99-kubernetes.conf
        reload: yes
      with_dict:
        net.bridge.bridge-nf-call-iptables: '1'
        net.ipv4.ip_forward: '1'
        net.bridge.bridge-nf-call-ip6tables: '1'

    - name: Set SELinux to permissive (Required for kubelet/CRI-O operation)
      ansible.posix.selinux:
        state: "{{ selinux_state }}"
        policy: targeted

    - name: Enable and start CRI-O
      ansible.builtin.service:
        name: crio
        state: started
        enabled: yes

    - name: Stop and disable firewalld service
      ansible.builtin.service:
        name: firewalld
        state: stopped
        enabled: no
      ignore_errors: yes
