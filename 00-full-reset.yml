---
- name: 00 - Nuclear Reset of Kubernetes Cluster (Data Destruction)
  hosts: all
  become: true
  tasks:
  
    - name: Stop Kubernetes and Runtime Services
      service:
        name: "{{ item }}"
        state: stopped
      loop:
        - kubelet
        - crio
      ignore_errors: true

    - name: Reset kubeadm (Force with CRI-O socket)
      command: kubeadm reset -f --cri-socket unix:///var/run/crio/crio.sock
      ignore_errors: true

    - name: Remove Kubernetes and CNI Configuration Directories
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/cni/net.d
        - /etc/kubernetes
        - /root/.kube
        - /var/lib/etcd
        - /var/lib/kubelet
        - /var/lib/dockershim
        - /var/run/kubernetes
        - /var/lib/cni
        - /var/lib/calico
        - /var/lib/crio

    - name: Nuke Rook-Ceph Data Directory
      file:
        path: /var/lib/rook
        state: absent

    - name: Zap Ceph OSD Disk Headers (Optional - For Raw Disks)
      shell: |
       sgdisk --zap-all /dev/sda
        wipefs -a /dev/sda
      ignore_errors: true

    - name: Flush IPTables and IPVS
      shell: |
        iptables -F && iptables -t nat -F && iptables -t mangle -F && iptables -X
        ipvsadm -C || true
      ignore_errors: true

    - name: Delete CNI Network Interfaces
      shell: ip link delete {{ item }}
      loop:
        - cni0
        - flannel.1
        - kube-ipvs0
        - dummy0
      ignore_errors: true

    - name: Restart CRI-O
      service:
        name: crio
        state: started
        enabled: yes
      ignore_errors: true

    - name: Reboot Node to Finalize Cleanup
      reboot:
        reboot_timeout: 300
